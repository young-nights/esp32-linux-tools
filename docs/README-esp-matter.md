# esp-matter 环境搭建

## 0. 前言

[esp-matter](https://github.com/espressif/esp-matter) 项目仓库及其附带的子仓库位于 github，国内一些地区从 github 克隆仓库非常慢，同时由于 esp-matter 仓库及子仓库非常大，导致克隆时间非常长且易失败。另外，esp-matter 环境安装过程中需要访问一些外网，导致部分资源不能获取。以上两点可通过特殊上网手段解决，但考虑到并非所有开发者均有此条件，本文简要介绍了一种在国内快速搭建 esp-matter 开发环境的方法。

## 1. 步骤

### 1.1 准备

ubuntu 20.04/22.04，其他发行版未做验证，ubuntu 软件源请自行改为国内的。

### 1.2 设置 github 镜像

```shell
git clone https://gitee.com/EspressifSystems/esp-gitee-tools.git
cd esp-gitee-tools
./jihu-mirror.sh set	# 可通过 ./jihu-mirror.sh unset 取消设置
```

### 1.3 安装 esp-idf 依赖包

以 esp-idf v4.4 为例，具体参考 esp-idf 编程手册中环境搭建部分章节。

```shell
sudo apt-get install git wget flex bison gperf python3 python3-pip python3-setuptools cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0
```

> 拷贝以上命令时，注意换行问题，python3-setuptools 需要是连续的。

### 1.4 设置 python 源到国内

```shell
pip config set global.index-url http://mirrors.aliyun.com/pypi/simple
pip config set global.trusted-host mirrors.aliyun.com
```

### 1.5 拉取 esp-idf 并安装设置环境

```shell
git clone --recursive --single-branch --branch release/v4.4 https://github.com/espressif/esp-idf.git
cd esp-idf
export IDF_GITHUB_ASSETS="dl.espressif.com/github_assets"
./install.sh
. ./export.sh
```

### 1.6 拉取 esp-matter 并做相应修改

```shell
git clone https://github.com/espressif/esp-matter.git
cd esp-matter
git submodule update --init
connectedhomeip/connectedhomeip/scripts/checkout_submodules.py --shallow --platform esp32
```

以上命令仅拉取与 esp32 相关的 connectedhomeip 子仓库，如想拉取完整工程，也可使用如下命令：

```shell
git clone --recursive https://github.com/espressif/esp-matter.git
```

- 如已克隆 esp-matter，并做过安装尝试，删除 esp-matter/connectedhomeip/connectedhomeip/.environment 目录

- esp-matter/export.sh 中，注释掉 `export PATH=${PATH}:${ESP_MATTER_PATH}/connectedhomeip/connectedhomeip/.environment/cipd/packages/pigweed/` 和 `export PATH=${PATH}:${ESP_MATTER_PATH}/connectedhomeip/connectedhomeip/examples/chip-tool/out/` 两行，增加 `export PATH=${PATH}:${ESP_MATTER_PATH}/connectedhomeip/connectedhomeip/out/host/`

- 补充 pigweed_environment.gni 文件

  ```
  cd esp-matter
  touch connectedhomeip/connectedhomeip/build_overrides/pigweed_environment.gni
  ```

  添加 pigweed_environment.gni 文件内容为：

  ```
  # This file is automatically generated by Pigweed's environment setup. Do not
  # edit it manually or check it in.
  declare_args() {
    pw_env_setup_CIPD_ARM = "//.environment/cipd/packages/arm"
    dir_cipd_arm = "//.environment/cipd/packages/arm"
    pw_env_setup_CIPD_PIGWEED = "//.environment/cipd/packages/pigweed"
    dir_cipd_pigweed = "//.environment/cipd/packages/pigweed"
    pw_env_setup_CIPD_PYTHON = "//.environment/cipd/packages/python"
    dir_cipd_python = "//.environment/cipd/packages/python"
    pw_env_setup_VIRTUAL_ENV = "//.environment/pigweed-venv"
    pw_env_setup_PACKAGE_ROOT = "//.environment/packages"
  }
  ```

### 1.7 安装 connectedhomeip 依赖包

```shell
sudo apt-get install gn pkg-config libglib2.0-dev python3-venv libgirepository-1.0-1 libdbus-1-dev
```

对于 ubuntu 20.04 用户，源上没有 gn，可以手动下载 gn 进行安装。

```shell
sudo apt-get install unzip
wget https://dl.espressif.com/AE/gn-linux-amd64-2071.zip 
sudo unzip gn-linux-amd64-2071.zip -d /usr/bin/
```

### 1.8 编译 connectedhomeip 相关工具

```shell
cd esp-matter/connectedhomeip/connectedhomeip
gn gen out/host
# 下面命令会编译所有工具，需要耗费一些时间，暂不推荐使用
ninja -C out/host
# 也可用以下命令单独编译 esp-matter 所需工具，较快，推荐使用
ninja -C out/host chip-cert
ninja -C out/host chip-tool
ninja -C out/host spake2p
```

> 以上工具需要在 connectedhomeip 更新后重新编译，如未更新，不需要每次编译。

### 1.9 设置 esp-matter 环境

```shell
cd esp-matter
# 注意：不需要 ./install.sh
. ./export.sh
```

### 1.10 编译 esp-matter 示例

```shell
cd esp-matter/examples/light
idf.py set-target esp32c3
idf.py build
```